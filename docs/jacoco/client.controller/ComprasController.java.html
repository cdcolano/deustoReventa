<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ComprasController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">deustoReventaDOREST</a> &gt; <a href="index.source.html" class="el_package">client.controller</a> &gt; <span class="el_source">ComprasController.java</span></div><h1>ComprasController.java</h1><pre class="source lang-java linenums">package client.controller;

import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.sql.Date;
import java.util.ArrayList;
import java.util.Comparator;
import java.util.List;

import javax.swing.BoxLayout;
import javax.swing.JButton;
import javax.swing.JLabel;
import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.ws.rs.client.Entity;
import javax.ws.rs.client.Invocation;
import javax.ws.rs.client.WebTarget;
import javax.ws.rs.core.GenericType;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;
import javax.ws.rs.core.Response.Status;

import org.datanucleus.enhancer.methods.GetObjectId;

import serialization.Compra;
import serialization.Producto;
import serialization.ProductoOrdenador;
import serialization.ProductoVehiculo;
import serialization.Usuario;
import util.ReventaException;

public class ComprasController {
	private WebTarget webTarget;
	private String email,nombre;
	private Producto prod;
	private List&lt;Producto&gt;productos,productosFav;
	
	
	
	
	public ComprasController(WebTarget webTarget, String email) {
<span class="nc" id="L42">		super();</span>
<span class="nc" id="L43">		this.webTarget = webTarget;</span>
<span class="nc" id="L44">		this.email = email;</span>
<span class="nc" id="L45">	}</span>

	public void comprar(String email, int idProducto, double precio) throws ReventaException {
<span class="nc" id="L48">		WebTarget webTarget = this.webTarget.path(&quot;reventa/comprar/&quot;+email +&quot;/&quot;+ idProducto);</span>
<span class="nc" id="L49">		Invocation.Builder invocationBuilder = webTarget.request(MediaType.APPLICATION_JSON);</span>
<span class="nc" id="L50">		Compra c= new Compra();</span>
<span class="nc" id="L51">		c.setPrecio(precio);</span>
<span class="nc" id="L52">		Response response = invocationBuilder.post(Entity.entity(c, MediaType.APPLICATION_JSON));</span>
<span class="nc bnc" id="L53" title="All 2 branches missed.">		if (response.getStatus() != Status.OK.getStatusCode()) {</span>
<span class="nc" id="L54">			throw new ReventaException(&quot;&quot; + response.getStatus());</span>
		}
<span class="nc" id="L56">	}</span>

	public void anadirUsuarioFav(Usuario u, String email) throws ReventaException {
<span class="nc" id="L59">		WebTarget webTarget = this.webTarget.path(&quot;reventa/anadirUsuarioFav/&quot;+ email);</span>
<span class="nc" id="L60">		Invocation.Builder invocationBuilder = webTarget.request(MediaType.APPLICATION_JSON);</span>
<span class="nc" id="L61">		Response response = invocationBuilder.post(Entity.entity(u, MediaType.APPLICATION_JSON));</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">		if (response.getStatus() != Status.OK.getStatusCode()) {</span>
<span class="nc" id="L63">			throw new ReventaException(&quot;&quot; + response.getStatus());</span>
		}
<span class="nc" id="L65">	}</span>
	public List&lt;Producto&gt; getProductos() throws ReventaException{
<span class="nc" id="L67">		WebTarget webTarget = this.webTarget.path(&quot;reventa/productosOrdenador&quot;);</span>
<span class="nc" id="L68">		List&lt;ProductoOrdenador&gt;lProductosOrdenador = webTarget.request( MediaType.APPLICATION_JSON ).get( new GenericType&lt;List&lt;ProductoOrdenador&gt;&gt;() {</span>
	     } );
<span class="nc" id="L70">		WebTarget webTarget2 = this.webTarget.path(&quot;reventa/productosVehiculo&quot;);</span>
<span class="nc" id="L71">		List&lt;ProductoVehiculo&gt;lProductosVehiculo = webTarget2.request( MediaType.APPLICATION_JSON ).get( new GenericType&lt;List&lt;ProductoVehiculo&gt;&gt;() {</span>
	     } );
<span class="nc" id="L73">		List&lt;Producto&gt;lProductos= new ArrayList&lt;&gt;();</span>
<span class="nc" id="L74">		lProductos.addAll(lProductosOrdenador);</span>
<span class="nc" id="L75">		lProductos.addAll(lProductosVehiculo);</span>
<span class="nc" id="L76">		return lProductos;</span>
	}
	
	public List&lt;Producto&gt; getProductosEnVenta() throws ReventaException{
<span class="nc" id="L80">		WebTarget webTarget = this.webTarget.path(&quot;reventa/productosOrdenador/venta&quot;);</span>
<span class="nc" id="L81">		List&lt;ProductoOrdenador&gt;lProductosOrdenador = webTarget.request( MediaType.APPLICATION_JSON ).get( new GenericType&lt;List&lt;ProductoOrdenador&gt;&gt;() {</span>
	     } );
<span class="nc" id="L83">		WebTarget webTarget2 = this.webTarget.path(&quot;reventa/productosVehiculo/venta&quot;);</span>
<span class="nc" id="L84">		List&lt;ProductoVehiculo&gt;lProductosVehiculo = webTarget2.request( MediaType.APPLICATION_JSON ).get( new GenericType&lt;List&lt;ProductoVehiculo&gt;&gt;() {</span>
	    } );
<span class="nc" id="L86">		List&lt;Producto&gt;lProductos= new ArrayList&lt;&gt;();</span>
<span class="nc" id="L87">		lProductos.addAll(lProductosOrdenador);</span>
<span class="nc" id="L88">		lProductos.addAll(lProductosVehiculo);</span>
<span class="nc" id="L89">		return lProductos;</span>
	}
	
	public Producto getProducto(int idProducto)throws ReventaException {
<span class="nc" id="L93">		WebTarget webTarget = this.webTarget.path(&quot;collector/getProducto/&quot;+ idProducto);</span>
<span class="nc" id="L94">		Invocation.Builder invocationBuilder = webTarget.request(MediaType.APPLICATION_JSON);</span>
<span class="nc" id="L95">		Response response = invocationBuilder.get();</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">		if (response.getStatus() == Status.OK.getStatusCode()) {</span>
<span class="nc" id="L97">			Producto producto = response.readEntity(Producto.class);</span>
<span class="nc" id="L98">			return producto;</span>
		} else {
<span class="nc" id="L100">			throw new ReventaException(&quot;&quot; + response.getStatus());</span>
		}
	}
	
	public List&lt;Producto&gt; getProductosFavoritos() throws ReventaException{
<span class="nc" id="L105">		WebTarget webTarget = this.webTarget.path(&quot;reventa/productosOrdenador/favoritos/&quot;+ email);</span>
<span class="nc" id="L106">		List&lt;ProductoOrdenador&gt;lProductosOrdenador = webTarget.request( MediaType.APPLICATION_JSON ).get( new GenericType&lt;List&lt;ProductoOrdenador&gt;&gt;() {</span>
	     } );
<span class="nc" id="L108">		WebTarget webTarget2 = this.webTarget.path(&quot;reventa/productosVehiculo/favoritos/&quot;+ email);</span>
<span class="nc" id="L109">		List&lt;ProductoVehiculo&gt;lProductosVehiculo = webTarget2.request( MediaType.APPLICATION_JSON ).get( new GenericType&lt;List&lt;ProductoVehiculo&gt;&gt;() {</span>
	    } );
<span class="nc" id="L111">		List&lt;Producto&gt;lProductos= new ArrayList&lt;&gt;();</span>
<span class="nc" id="L112">		lProductos.addAll(lProductosOrdenador);</span>
<span class="nc" id="L113">		lProductos.addAll(lProductosVehiculo);</span>
<span class="nc" id="L114">		return lProductos;</span>
	}
	
	
	public void crearPanel(Producto p, JPanel pCentro) {
<span class="nc" id="L119">		this.prod=p;</span>
<span class="nc" id="L120">		JPanel pContenido= new JPanel();</span>
<span class="nc" id="L121">		pContenido.setLayout(new BoxLayout(pContenido, BoxLayout.Y_AXIS));</span>
<span class="nc" id="L122">		JPanel pProducto= new JPanel();</span>
<span class="nc" id="L123">		pProducto.add(new JLabel (p.getNombre()));</span>
<span class="nc" id="L124">		pProducto.add(new JLabel(&quot;&quot;+ p.getPrecioSalida()+ &quot;€&quot;));</span>
<span class="nc" id="L125">		JButton button= new JButton(&quot;Comprar&quot;);</span>
<span class="nc" id="L126">		button.addActionListener(new ActionListener() {</span>

			@Override
			public void actionPerformed(ActionEvent e) {
				try {
<span class="nc" id="L131">					System.out.println(p.getId());</span>
<span class="nc" id="L132">					comprar(ComprasController.this.email,p.getId(),p.getPrecioSalida());</span>
<span class="nc" id="L133">					pCentro.removeAll();</span>
<span class="nc" id="L134">					productos.remove(p);</span>
<span class="nc" id="L135">					pCentro.removeAll();</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">					for (Producto p1: productos) {</span>
<span class="nc" id="L137">						crearPanel(p1, pCentro);</span>
<span class="nc" id="L138">					}</span>
<span class="nc" id="L139">					pCentro.revalidate();</span>
					
<span class="nc" id="L141">				} catch (ReventaException e1) {</span>
<span class="nc" id="L142">					System.out.println(e1.getMessage());</span>
<span class="nc" id="L143">				}</span>
<span class="nc" id="L144">			}</span>
			
		});

<span class="nc" id="L148">		JButton bMeGusta = new JButton(&quot;Añadir a favoritos&quot;);</span>
<span class="nc" id="L149">		JButton bUsuarioFav = new JButton(&quot;Me gusta&quot;);</span>
		
<span class="nc" id="L151">		bMeGusta.addActionListener(new ActionListener() {</span>

			@Override
			public void actionPerformed(ActionEvent e) {
				try {
<span class="nc" id="L156">					anadirFav(p,email)	;				//ComprasController.this.();</span>
										
<span class="nc" id="L158">				} catch (ReventaException e1) {</span>
<span class="nc" id="L159">					System.out.println(e1.getMessage());</span>
<span class="nc" id="L160">				}</span>
<span class="nc" id="L161">			}</span>
			
		});
<span class="nc" id="L164">		bUsuarioFav.addActionListener(new ActionListener() {</span>

			@Override
			public void actionPerformed(ActionEvent e) {
				try {
<span class="nc" id="L169">					anadirUsuarioFav(p.getEmailVendedor(),email);				//ComprasController.this.();</span>
										
<span class="nc" id="L171">				} catch (ReventaException e1) {</span>
<span class="nc" id="L172">					System.out.println(e1.getMessage());</span>
<span class="nc" id="L173">				}</span>
<span class="nc" id="L174">			}</span>
			
		});
<span class="nc" id="L177">		pContenido.add(pProducto);</span>
		
<span class="nc" id="L179">		pContenido.add(button);</span>
<span class="nc" id="L180">		pContenido.add(bMeGusta);</span>
<span class="nc" id="L181">		pContenido.add(bUsuarioFav);</span>
<span class="nc" id="L182">		JScrollPane jsp= new JScrollPane(pContenido);</span>
<span class="nc" id="L183">		pCentro.add(jsp);</span>
<span class="nc" id="L184">		pCentro.revalidate();</span>
<span class="nc" id="L185">		pCentro.repaint();</span>

<span class="nc" id="L187">	}</span>
	
	public void anadirFav(Producto p, String email) throws ReventaException {
<span class="nc" id="L190">		WebTarget webTarget = this.webTarget.path(&quot;reventa/anadirFav/&quot;+ email);</span>
<span class="nc" id="L191">		Invocation.Builder invocationBuilder = webTarget.request(MediaType.APPLICATION_JSON);</span>
<span class="nc" id="L192">		Response response = invocationBuilder.post(Entity.entity(p.getId(), MediaType.APPLICATION_JSON));</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">		if (response.getStatus() != Status.OK.getStatusCode()) {</span>
<span class="nc" id="L194">			throw new ReventaException(&quot;&quot; + response.getStatus());</span>
		}
<span class="nc" id="L196">	}</span>
	public void anadirUsuarioFav(String email2, String email) throws ReventaException {
<span class="nc" id="L198">		WebTarget webTarget = this.webTarget.path(&quot;reventa/anadirUsuarioFav/&quot;+ email);</span>
<span class="nc" id="L199">		Invocation.Builder invocationBuilder = webTarget.request(MediaType.APPLICATION_JSON);</span>
<span class="nc" id="L200">		Response response = invocationBuilder.post(Entity.entity(email2, MediaType.APPLICATION_JSON));</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">		if (response.getStatus() != Status.OK.getStatusCode()) {</span>
<span class="nc" id="L202">			throw new ReventaException(&quot;&quot; + response.getStatus());</span>
		}
<span class="nc" id="L204">	}</span>
	
	public int getVentas(String email)throws ReventaException {
<span class="nc" id="L207">		WebTarget webTarget = this.webTarget.path(&quot;reventa/numVentas/&quot;+ email);</span>
<span class="nc" id="L208">		Invocation.Builder invocationBuilder = webTarget.request(MediaType.APPLICATION_JSON);</span>
<span class="nc" id="L209">		Response response = invocationBuilder.get();</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">		if (response.getStatus() == Status.OK.getStatusCode()) {</span>
<span class="nc" id="L211">			int u = response.readEntity(Integer.class);</span>
<span class="nc" id="L212">			return u;</span>
			
		} else {
<span class="nc" id="L215">			throw new ReventaException(&quot;&quot; + response.getStatus());</span>
		}
	}
	
	public void ordenarPorVentas(JPanel pCentro) {
<span class="nc" id="L220">		productos.sort(new Comparator&lt;Producto&gt;(){</span>
			   @Override
			   public int compare(Producto p1,Producto p2) {
				   try {
<span class="nc" id="L224">					   Integer u1=getVentas(p1.getEmailVendedor());</span>
<span class="nc" id="L225">					   Integer u2=getVentas(p2.getEmailVendedor());</span>
<span class="nc" id="L226">					   System.out.println(u1 + &quot; &quot; +p1.getEmailVendedor());</span>
<span class="nc" id="L227">					   System.out.println(u2+ &quot; &quot; + p2.getEmailVendedor());</span>
<span class="nc" id="L228">					   return u1.compareTo(u2);</span>
				   }
<span class="nc" id="L230">					catch(Exception exc) {</span>
<span class="nc" id="L231">						System.out.println(&quot;*ERROR * &quot; + exc.getMessage());</span>
<span class="nc" id="L232">						return 0;</span>
					}
			     //TODO return 1 if rhs should be before lhs 
			     //     return -1 if lhs should be before rhs
			     //     return 0 otherwise (meaning the order stays the same)
			     }
			 });
<span class="nc" id="L239">		pCentro.removeAll();</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">		for (Producto p:productos) {</span>
<span class="nc" id="L241">			crearPanel(p, pCentro);</span>
<span class="nc" id="L242">		}</span>
<span class="nc" id="L243">		pCentro.revalidate();</span>
		//TODO si no pCentro repaint
		
<span class="nc" id="L246">	}</span>
	
	
	public void ordenarPorFechaAsc( JPanel pCentro) {
<span class="nc" id="L250">		productos.sort(new Comparator&lt;Producto&gt;(){</span>
			   @Override
			   public int compare(Producto p1,Producto p2) {
				   
<span class="nc" id="L254">		               Date Pdate = new Date(p1.getFechaPubli());</span>
<span class="nc" id="L255">		               Date Qdate= new Date(p2.getFechaPubli());</span>
<span class="nc" id="L256">					   return Pdate.compareTo(Qdate);</span>
				 //TODO return 1 if rhs should be before lhs 
			     //     return -1 if lhs should be before rhs
			     //     return 0 otherwise (meaning the order stays the same)
			     }
			 });
<span class="nc" id="L262">		pCentro.removeAll();</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">		for (Producto p:productos) {</span>
<span class="nc" id="L264">			crearPanel(p, pCentro);</span>
<span class="nc" id="L265">		}</span>
<span class="nc" id="L266">		pCentro.revalidate();</span>
		//TODO si no pCentro repaint
<span class="nc" id="L268">	}</span>
	
	
	public void ordenarPorFechaDesc(JPanel pCentro) {
<span class="nc" id="L272">		productos.sort(new Comparator&lt;Producto&gt;(){</span>
			   @Override
			   public int compare(Producto p1,Producto p2) {
				   try {
<span class="nc" id="L276">		               Date Pdate = new Date(p1.getFechaPubli());</span>
<span class="nc" id="L277">		               Date Qdate= new Date(p2.getFechaPubli());</span>
<span class="nc" id="L278">					   return Qdate.compareTo(Pdate);</span>
				   }
<span class="nc" id="L280">					catch(Exception exc) {</span>
<span class="nc" id="L281">						System.out.println(&quot;*ERROR * &quot; + exc.getMessage());</span>
<span class="nc" id="L282">						return 0;</span>
					}
			     //TODO return 1 if rhs should be before lhs 
			     //     return -1 if lhs should be before rhs
			     //     return 0 otherwise (meaning the order stays the same)
			     }
			 });
<span class="nc" id="L289">		pCentro.removeAll();</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">		for (Producto p:productos) {</span>
<span class="nc" id="L291">			crearPanel(p, pCentro);</span>
<span class="nc" id="L292">		}</span>
<span class="nc" id="L293">		pCentro.revalidate();</span>
		//TODO si no pCentro repaint
<span class="nc" id="L295">	}</span>
	
	
	public void mostrarFavoritos(JPanel pCentro, String email) {
		try {
<span class="nc" id="L300">			List&lt;Producto&gt;productos= getProductosFavoritos();</span>
<span class="nc" id="L301">			System.out.println(&quot;Se estan haciendo los favoritos&quot;);</span>
<span class="nc" id="L302">			pCentro.removeAll();</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">			for (Producto p: productos) {</span>
<span class="nc" id="L304">				System.out.println(&quot;fav&quot;);</span>
<span class="nc" id="L305">				crearPanel(p, pCentro);</span>
<span class="nc" id="L306">			}</span>
<span class="nc" id="L307">			pCentro.revalidate();</span>
<span class="nc" id="L308">			pCentro.repaint();</span>
<span class="nc" id="L309">		} catch (ReventaException e) {</span>
			// TODO Auto-generated catch block
<span class="nc" id="L311">			e.printStackTrace();</span>
<span class="nc" id="L312">		}</span>
		
		
<span class="nc" id="L315">	}</span>

	public void setProductos(List&lt;Producto&gt; productos) {
<span class="nc" id="L318">		this.productos = productos;</span>
<span class="nc" id="L319">	}</span>
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>