<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UsuarioDAO.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">deustoReventaDOREST</a> &gt; <a href="index.source.html" class="el_package">dao</a> &gt; <span class="el_source">UsuarioDAO.java</span></div><h1>UsuarioDAO.java</h1><pre class="source lang-java linenums">package dao;

import java.util.ArrayList;
import java.util.List;

import javax.jdo.Extent;
import javax.jdo.JDOHelper;
import javax.jdo.PersistenceManager;
import javax.jdo.PersistenceManagerFactory;
import javax.jdo.Query;
import javax.jdo.Transaction;

import serialization.Categoria;
import serialization.*;

public class UsuarioDAO implements IUsuarioDAO {
	

	private PersistenceManagerFactory pmf;

<span class="fc" id="L21">	public UsuarioDAO() {</span>
<span class="fc" id="L22">		pmf = JDOHelper.getPersistenceManagerFactory(&quot;datanucleus.properties&quot;);</span>
<span class="fc" id="L23">	}</span>

	public void storeUsuario(Usuario usuario) {
<span class="fc" id="L26">		this.storeObject(usuario);</span>
<span class="fc" id="L27">	}</span>

	private void storeObject(Object object) {
<span class="fc" id="L30">		PersistenceManager pm = pmf.getPersistenceManager();</span>
<span class="fc" id="L31">		Transaction tx = pm.currentTransaction();</span>

		try {
<span class="fc" id="L34">			tx.begin();</span>
<span class="fc" id="L35">			System.out.println(&quot;   * Storing an object: &quot; + object);</span>
<span class="fc" id="L36">			pm.makePersistent(object);</span>
<span class="fc" id="L37">			tx.commit();</span>
<span class="fc" id="L38">		} catch (Exception ex) {</span>
<span class="fc" id="L39">			System.out.println(&quot;   $ Error storing an object: &quot; + ex.getMessage());</span>
		} finally {
<span class="pc bpc" id="L41" title="1 of 4 branches missed.">			if (tx != null &amp;&amp; tx.isActive()) {</span>
<span class="fc" id="L42">				tx.rollback();</span>
			}

<span class="fc" id="L45">			pm.close();</span>
		}
<span class="fc" id="L47">	}</span>

	public List&lt;Usuario&gt; getUsuarios() {
<span class="fc" id="L50">		PersistenceManager pm = pmf.getPersistenceManager();</span>
		/*
		 * By default only 1 level is retrieved from the db so if we wish to fetch more
		 * than one level, we must indicate it
		 */

<span class="fc" id="L56">		Transaction tx = pm.currentTransaction();</span>
<span class="fc" id="L57">		List&lt;Usuario&gt; usuarios = new ArrayList&lt;&gt;();</span>

		try {
<span class="fc" id="L60">			System.out.println(&quot;   * Retrieving an Extent for Products.&quot;);</span>

<span class="fc" id="L62">			tx.begin();</span>
<span class="fc" id="L63">			Extent&lt;Usuario&gt; extent = pm.getExtent(Usuario.class, true);</span>

<span class="fc bfc" id="L65" title="All 2 branches covered.">			for (Usuario u : extent) {</span>
<span class="fc" id="L66">				usuarios.add(u);</span>
<span class="fc" id="L67">			}</span>

<span class="fc" id="L69">			tx.commit();</span>
<span class="fc" id="L70">		} catch (Exception ex) {</span>
<span class="fc" id="L71">			System.out.println(&quot;   $ Error retrieving an extent: &quot; + ex.getMessage());</span>
		} finally {
<span class="pc bpc" id="L73" title="2 of 4 branches missed.">			if (tx != null &amp;&amp; tx.isActive()) {</span>
<span class="fc" id="L74">				tx.rollback();</span>
			}

<span class="fc" id="L77">			pm.close();</span>
		}

<span class="fc" id="L80">		return usuarios;</span>
	}
	
	
	




	@SuppressWarnings(&quot;unchecked&quot;)
/*	public List&lt;Product&gt; getProducts(String condition) {
		PersistenceManager pm = pmf.getPersistenceManager();
		pm.getFetchPlan().setMaxFetchDepth(3);

		Transaction tx = pm.currentTransaction();
		List&lt;Product&gt; products = new ArrayList&lt;Product&gt;();

		try {
			System.out.println(&quot;   * Executing a Query for Products given a condition: &quot; + condition);

			tx.begin();
			Extent&lt;Product&gt; extent = pm.getExtent(Product.class, true);
			Query&lt;Product&gt; query = pm.newQuery(extent, condition);

			for (Product product : (List&lt;Product&gt;) query.execute()) {
				products.add(product);
			}

			tx.commit();
		} catch (Exception ex) {
			System.out.println(&quot;   $ Error retreiving an extent: &quot; + ex.getMessage());
		} finally {
			if (tx != null &amp;&amp; tx.isActive()) {
				tx.rollback();
			}

			pm.close();
		}

		return products;
	}*/

	public Usuario getUsuario(String email) {
<span class="fc" id="L123">		PersistenceManager pm = pmf.getPersistenceManager();</span>
<span class="fc" id="L124">		Usuario usuario = null;</span>

		try {
<span class="fc" id="L127">			usuario=pm.getObjectById(Usuario.class, email);</span>
<span class="fc" id="L128">			pm.makeTransient(usuario);</span>
//			System.out.println(usuario.getEmail());

<span class="fc" id="L131">		} catch (Exception ex) {</span>
<span class="fc" id="L132">			System.out.println(&quot;   $ Error no existe ese usuario: &quot; + ex.getMessage());</span>
<span class="fc" id="L133">			return null;</span>
		} finally {
			//System.out.println(usuario.getEmail());
<span class="fc" id="L136">			pm.close();</span>
		}

<span class="fc" id="L139">		return usuario;</span>
	}
	
	
	/*public int getComprasSize() {
		PersistenceManager pm = pmf.getPersistenceManager();
		pm.getFetchPlan().setMaxFetchDepth(3);

		Transaction tx = pm.currentTransaction();
		int resultado=0;

		try {
			System.out.println(&quot;   * Querying a Compras Size: &quot;);

			tx.begin();
			Query&lt;?&gt; query = pm.newQuery(&quot;SELECT COUNT(*)  FROM &quot; + Compra.class.getName());
			resultado = (Integer) query.execute();
			tx.commit();

		} catch (Exception ex) {
			System.out.println(&quot;   $ Error retreiving an extent: &quot; + ex.getMessage());
		} finally {
			if (tx != null &amp;&amp; tx.isActive()) {
				tx.rollback();
			}

			pm.close();
		}

		return resultado;
	}
	*/
	/*public void updateUsuario(Usuario usuario, Compra c) {
		PersistenceManager pm = pmf.getPersistenceManager();
		Usuario u=pm.getObjectById(Usuario.class,usuario.getEmail());
		Usuario temporal=u.clone();
		temporal.getCompras().add(c);
		pm.deletePersistent(u);
		pm.makePersistent(temporal);
		pm.close();
	}
	*/
	
	

	/*public void deleteUsuario(Usuario usuario) {
		PersistenceManager pm = pmf.getPersistenceManager();
		Transaction tx = pm.currentTransaction();
		try {
			tx.begin();
			pm.deletePersistent(usuario);
			tx.commit();
		} catch (Exception ex) {
			System.out.println(&quot;   $ Error updating: &quot; + ex.getMessage());
		} finally {
			if (tx != null &amp;&amp; tx.isActive()) {
				tx.rollback();
			}
			pm.close();
		}
	}*/
	
	public PersistenceManagerFactory getPmf() {
<span class="fc" id="L202">		return pmf;</span>
	}

	public void setPmf(PersistenceManagerFactory pmf) {
<span class="fc" id="L206">		this.pmf = pmf;</span>
<span class="fc" id="L207">	}</span>

/*	public void updateVentasUsuario(String email, Producto p) {
		PersistenceManager pm = pmf.getPersistenceManager();
		try {
			Usuario u=pm.getObjectById(Usuario.class,email);
			u.getProductos().add(p);
		} catch (Exception ex) {
			System.out.println(&quot;   $ Error updating: &quot; + ex.getMessage());
		} finally {
			pm.close();
		}
	}

	public void deleteAllUsuarios() {
		System.out.println(&quot;- Cleaning the DB...&quot;);
		PersistenceManager pm = pmf.getPersistenceManager();
		Transaction tx = pm.currentTransaction();
		try {
			tx.begin();
			
			// Getting ready for removing objects - Remove Relationships between User and other things
			Extent&lt;Usuario&gt; extentU = pm.getExtent(Usuario.class, true);
			
		
			// Updating the database so changes are considered before commit
			pm.flush();

			// Deleting All Products - Copies in Books will be deleted due to 'delete on cascade'
			Query&lt;Usuario&gt; query2 = pm.newQuery(Usuario.class);
			System.out.println(&quot; * '&quot; + query2.deletePersistentAll() + &quot;' products deleted from the DB.&quot;);

			tx.commit();
		} catch (Exception ex) {
			System.err.println(&quot; $ Error cleaning the DB: &quot; + ex.getMessage());
			ex.printStackTrace();
		} finally {
			if (tx != null &amp;&amp; tx.isActive()) {
				tx.rollback();
			}

			if (pm != null &amp;&amp; !pm.isClosed()) {
				pm.close();
			}
		}
	}*/

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>